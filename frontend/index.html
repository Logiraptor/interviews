<html>
    <head>
        <script src="static/dropzone-5.7.0/dist/min/dropzone.min.js"> </script>
        <link href="static/dropzone-5.7.0/dist/min/dropzone.min.css" rel="stylesheet"/>
        <script>
         Dropzone.options.audioUpload = {
             /* acceptedFiles: "image/png, image/jpeg, image/jpeg, video/mp4", */
             method: "PUT",
             timeout: null, // Dropzone has a default time out of 30sec
             // Get Upload Url dynamically
             url: function (files) {
                 console.log(files[0].dynamicUploadUrl);
                 return files[0].dynamicUploadUrl
             },
             headers: { // Remove unwanted headers
                 'Cache-Control': null,
                        'X-Requested-With': null,
                        'Accept': null,
             },
             // IMP: Have to make this configuration to send raw files to GCS
             sending: function (file, xhr) {
                 let _send = xhr.send;
                 xhr.send = function () {
                     _send.call(xhr, file);
                 };
             },
             init: function () {
                 this.on("success", function (file, response) {
                     //Inform the server. Uploaded Successfully
                     console.log("SUCCESS")
                 });
             },
             accept: function (file, done) {
                 console.log(file);
                 fetch("/signed-url?content_type=" + encodeURIComponent(file.type) + "&name=" + encodeURIComponent(file.name)).then(response => response.text()).then(url => {
                     file.dynamicUploadUrl = url;
                     done();
                 });
             }
         };
        </script>
    </head>

    <body>
        <form
            class="dropzone"
            id="audio-upload"></form>

        <table>
            <thead>
                <th>Uploaded</th>
                <th>Name</th>
                <th>Progress</th>
                <th>Transcript</th>
            </thead>
            <tbody>
                {{range .objects}}
                <tr>
                    <td>
                        {{.Uploaded}}
                    </td>
                    <td>
                        {{.Name}}
                    </td>
                    <td>
                        {{.Status}}
                    </td>
                    <td>
                        {{$job := .}}
                        {{with .Transcript}} 
                        <a target="_blank" href="{{$job.ResultUrl}}">Download Transcript</a>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </body>
</html>
